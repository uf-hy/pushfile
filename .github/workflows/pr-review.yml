name: PR AI Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Codex CLI
        run: npm install -g @openai/codex

      - name: Build review prompt from PR diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr diff ${{ github.event.pull_request.number }} > /tmp/pr.diff
          head -n 1200 /tmp/pr.diff > /tmp/pr.diff.short
          cat > /tmp/review.prompt <<'EOF'
          ä½ æ˜¯èµ„æ·±ä»£ç å®¡æŸ¥å‘˜ã€‚è¯·åŸºäºŽä»¥ä¸‹ PR diff è¾“å‡ºä¸­æ–‡å®¡æŸ¥ç»“è®ºï¼š
          1) å¿…é¡»æŒ‰ P0/P1/P2 åˆ†çº§è¾“å‡ºé—®é¢˜æ¸…å•ï¼š
             - P0: ä¼šå¯¼è‡´çº¿ä¸Šä¸å¯ç”¨/æ•°æ®é”™è¯¯/å®‰å…¨é—®é¢˜ï¼Œå¿…é¡»é˜»æ–­åˆå¹¶
             - P1: é‡è¦åŠŸèƒ½ç¼ºé™·æˆ–æ˜Žæ˜¾å›žå½’é£Žé™©ï¼Œå»ºè®®ä¿®å¤åŽåˆå¹¶
             - P2: ä½“éªŒæˆ–ä»£ç è´¨é‡ä¼˜åŒ–é¡¹ï¼Œå¯åŽç»­è¿­ä»£
          2) ç»™å‡ºæ¯ä¸ªé—®é¢˜çš„æ–‡ä»¶è·¯å¾„å’Œç®€çŸ­ä¿®å¤å»ºè®®
          3) ç»™å‡ºæµ‹è¯•è¦†ç›–å»ºè®®
          4) æœ€ç»ˆç»“è®ºï¼šå…è®¸åˆå¹¶ / éœ€ä¿®å¤åŽåˆå¹¶ / é˜»æ–­åˆå¹¶
          è¾“å‡ºç®€æ´ï¼Œé€‚åˆç›´æŽ¥è´´åˆ° PR è¯„è®ºã€‚
          EOF
          cat /tmp/pr.diff.short >> /tmp/review.prompt

      - name: Run AI Review
        env:
          CUSTOM_OPENAI_KEY: ${{ secrets.CODEX_API_KEY }}
        run: |
          if [ -z "${CUSTOM_OPENAI_KEY}" ]; then
            echo "æœªé…ç½® CODEX_API_KEYï¼Œè·³è¿‡ AI å®¡æŸ¥" > /tmp/review_result.md
            exit 0
          fi

          codex \
            -c 'model_providers.custom_openai.name="Custom OpenAI"' \
            -c 'model_providers.custom_openai.base_url="${{ secrets.CODEX_API_BASE }}"' \
            -c 'model_providers.custom_openai.env_key="CUSTOM_OPENAI_KEY"' \
            -c 'model_provider="custom_openai"' \
            exec --full-auto -m gpt-5.2 "$(cat /tmp/review.prompt)" > /tmp/review_result.md

      - name: Comment review result
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('/tmp/review_result.md', 'utf8');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `## ðŸ¤– AI PR å®¡æŸ¥\n\n${body}`,
            });
