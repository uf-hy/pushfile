# PR è‡ªåŠ¨å®¡æ ¸ â€” å¯¹æ‰€æœ‰ PR è¿›è¡Œä»£ç å®¡æŸ¥
# AI Agent PR: å®¡æ ¸ä¸é€šè¿‡è‡ªåŠ¨ä¿®å¤ï¼ˆæœ€å¤š 3 è½®ï¼‰
# äººå·¥ PR: åªå®¡æ ¸ä¸ä¿®å¤
# é€šçŸ¥: é€šè¿‡/åˆ°ä¸Šé™ â†’ Telegram é€šçŸ¥ + æ“ä½œæŒ‰é’®
name: PR Review

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]

permissions:
  pull-requests: write
  contents: write

jobs:
  review:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    if: "!contains(github.event.pull_request.title, 'promote')"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect PR source
        id: source
        run: |
          BRANCH="${{ github.event.pull_request.head.ref }}"
          if echo "$BRANCH" | grep -qE '^codex/issue-'; then
            echo "source=codex-agent" >> $GITHUB_OUTPUT
            echo "issue_num=$(echo $BRANCH | sed 's/codex\/issue-//')" >> $GITHUB_OUTPUT
            echo "desc=ğŸ¤– Codex Agent è‡ªåŠ¨ä¿®å¤ï¼ˆç”± Issue è§¦å‘ï¼‰" >> $GITHUB_OUTPUT
          elif echo "$BRANCH" | grep -qE '^opencode/issue-'; then
            echo "source=opencode-agent" >> $GITHUB_OUTPUT
            echo "issue_num=$(echo $BRANCH | sed 's/opencode\/issue-//')" >> $GITHUB_OUTPUT
            echo "desc=ğŸ¤– OpenCode Agent è‡ªåŠ¨ä¿®å¤ï¼ˆç”± Issue è§¦å‘ï¼‰" >> $GITHUB_OUTPUT
          else
            echo "source=manual" >> $GITHUB_OUTPUT
            echo "issue_num=" >> $GITHUB_OUTPUT
            echo "desc=ğŸ‘¤ äººå·¥æäº¤çš„ PR" >> $GITHUB_OUTPUT
          fi

      - name: Count review rounds
        id: rounds
        uses: actions/github-script@v7
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });
            const rounds = comments.data.filter(c =>
              c.body.includes('<!-- codex-review-round -->')
            ).length;
            core.setOutput('count', String(rounds));
            console.log(`Review rounds so far: ${rounds}`);

      - name: Get PR diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr diff ${{ github.event.pull_request.number }} > /tmp/pr_diff.txt 2>/dev/null || echo "Failed to get diff" > /tmp/pr_diff.txt
          head -c 30000 /tmp/pr_diff.txt > /tmp/pr_diff_truncated.txt

      - name: Write PR metadata to files
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const pr = context.payload.pull_request;
            fs.writeFileSync('/tmp/pr_title.txt', pr.title || '');
            fs.writeFileSync('/tmp/pr_body.txt', (pr.body || '').slice(0, 2000));

      - name: Get linked issue context
        if: steps.source.outputs.issue_num != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ steps.source.outputs.issue_num }}"
          gh issue view "$ISSUE_NUM" --json title,body --jq '"Issue #" + (.title) + "\n" + .body' > /tmp/issue_context.txt 2>/dev/null || echo "" > /tmp/issue_context.txt

      - name: Install Codex CLI
        run: npm install -g @openai/codex

      - name: Run AI Review
        env:
          CUSTOM_OPENAI_KEY: ${{ secrets.CODEX_API_KEY }}
        run: |
          SOURCE="${{ steps.source.outputs.source }}"
          ROUND="${{ steps.rounds.outputs.count }}"
          PR_TITLE=$(cat /tmp/pr_title.txt)
          PR_BODY=$(cat /tmp/pr_body.txt)
          DIFF=$(cat /tmp/pr_diff_truncated.txt)
          ISSUE_CTX=""
          if [ -f /tmp/issue_context.txt ]; then
            ISSUE_CTX=$(cat /tmp/issue_context.txt)
          fi

          if [ "$SOURCE" = "manual" ]; then
            cat > /tmp/review_prompt.txt <<'PROMPT_END'
          ä½ æ˜¯ä»£ç å®¡æ ¸ä¸“å®¶ã€‚è¿™æ˜¯ä¸€ä¸ªäººå·¥æäº¤çš„ PRã€‚

          ## å®¡æ ¸åŸåˆ™

          1. **èŒƒå›´é”å®š**ï¼šä»¥åŸå§‹ Issue çš„éœ€æ±‚ä¸ºè¾¹ç•Œï¼Œåªå®¡æ ¸ PR æ˜¯å¦æ­£ç¡®å®ç°äº† Issue è¦æ±‚çš„åŠŸèƒ½ã€‚
          2. **åŒç»´åº¦è¯„ä¼°**ï¼šåŒæ—¶è€ƒè™‘ Issue ä¼˜å…ˆçº§å’Œæ”¹åŠ¨åŒºåŸŸé£é™©ï¼š
             - æ”¹åŠ¨æ¶‰åŠè®¤è¯/æƒé™/æ”¯ä»˜/æ•°æ®è¿ç§» â†’ æ— è®º Issue ä¼˜å…ˆçº§ï¼Œä¸¥æ ¼å®¡æ ¸
             - æ”¹åŠ¨æ¶‰åŠæ™®é€šä¸šåŠ¡é€»è¾‘/UI/é…ç½® â†’ æŒ‰ Issue ä¼˜å…ˆçº§è°ƒæ•´æ ‡å‡†
          3. **é˜»å¡ vs å»ºè®®**ï¼š
             - ã€Œé˜»å¡ã€= åŠŸèƒ½ç¼ºå¤±ã€å®é™…å®‰å…¨æ¼æ´ã€ä¼šå´©æºƒ/ä¸¢æ•°æ®çš„ bug
             - ã€Œå»ºè®®ã€= ä»£ç é£æ ¼ã€æ–‡ä»¶ç»„ç»‡ã€å¯é€‰ä¼˜åŒ–ã€ç¼ºå°‘æµ‹è¯•

          ## å®¡æ ¸è¦ç‚¹

          1. **åŠŸèƒ½æ­£ç¡®æ€§** â€” æ˜¯å¦å®ç°äº† Issue æè¿°çš„éœ€æ±‚
          2. **å®‰å…¨æ€§** â€” æœ‰æ— å¯è¢«åˆ©ç”¨çš„æ¼æ´ï¼ˆè¶Šæƒã€æ³¨å…¥ã€æ•°æ®æ³„éœ²ç­‰ï¼‰
          3. **ç¨³å®šæ€§** â€” æœ‰æ— ä¼šå¯¼è‡´å´©æºƒã€æ•°æ®ä¸¢å¤±ã€åŠŸèƒ½ä¸å¯ç”¨çš„ bug
          4. **å›å½’é£é™©** â€” æ˜¯å¦ç ´åäº†ç°æœ‰åŠŸèƒ½

          ## ç»“è®ºä¸‰é€‰ä¸€

          - âœ… æ¨èåˆå¹¶ â€” éœ€æ±‚æ»¡è¶³ï¼Œæ— é˜»å¡é—®é¢˜
          - âš ï¸ éœ€è¦ä¿®æ”¹ â€” å­˜åœ¨é˜»å¡é—®é¢˜ï¼ˆæ¯æ¡å¿…é¡»è¯´æ˜è§¦å‘æ¡ä»¶å’Œç”¨æˆ·å¯è§åæœï¼‰
          - âŒ ä¸å»ºè®®åˆå¹¶ â€” æ–¹å‘é”™è¯¯æˆ–å¼•å…¥ä¸¥é‡é—®é¢˜

          è¶…å‡º Issue èŒƒå›´çš„æ”¹è¿›å»ºè®®å•ç‹¬åˆ—åœ¨ã€Œå»ºè®®ï¼ˆéé˜»å¡ï¼‰ã€åŒºåŸŸï¼Œä¸å½±å“åˆå¹¶ç»“è®ºã€‚
          PROMPT_END
          else
            cat > /tmp/review_prompt.txt <<PROMPT_END
          ä½ æ˜¯ä»£ç å®¡æ ¸ä¸“å®¶ã€‚è¿™æ˜¯ä¸€ä¸ª AI Agent (${SOURCE}) è‡ªåŠ¨ç”Ÿæˆçš„ PRï¼ˆç¬¬ $((ROUND+1)) è½®å®¡æ ¸ï¼‰ã€‚

          ## å®¡æ ¸åŸåˆ™ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰

          ### èŒƒå›´é”å®š
          åªå®¡æ ¸ PR æ˜¯å¦æ­£ç¡®å®ç°äº†åŸå§‹ Issue çš„éœ€æ±‚ã€‚Issue æ²¡è¦æ±‚çš„ä¸œè¥¿ä¸ç®—ç¼ºé™·ã€‚

          ### åŒç»´åº¦è¯„ä¼°
          åŒæ—¶è€ƒè™‘ä¸¤ä¸ªç»´åº¦æ¥å†³å®šå®¡æ ¸ä¸¥æ ¼åº¦ï¼š
          - **Issue ä¼˜å…ˆçº§**ï¼šé«˜ â†’ ä¸¥æ ¼ / ä¸­ä½ â†’ åŠŸèƒ½æ­£ç¡®+æ— æ¼æ´å³å¯
          - **æ”¹åŠ¨åŒºåŸŸé£é™©**ï¼šè®¤è¯/æƒé™/æ”¯ä»˜/æ•°æ®è¿ç§» â†’ æ— è®ºä¼˜å…ˆçº§éƒ½ä¸¥æ ¼å®¡æ ¸

          ### ç¡¬é—¨ç¦ï¼ˆä»»ä½•è½®æ¬¡éƒ½ä¸é™çº§ï¼‰
          ä»¥ä¸‹é—®é¢˜æ— è®ºç¬¬å‡ è½®éƒ½å¿…é¡»æ ‡è®°ä¸ºé˜»å¡ï¼š
          - éœ€æ±‚æœªå®ç°æˆ–å®ç°é”™è¯¯
          - å¯å½¢æˆæ”»å‡»è·¯å¾„çš„å®‰å…¨æ¼æ´ï¼ˆå³ä½¿æœ‰å‰ç½®æ¡ä»¶ï¼Œåªè¦å½±å“æ˜¯è¶Šæƒ/æ•°æ®æ³„éœ²/RCE/æ³¨å…¥ï¼Œå°±ç®—é˜»å¡ï¼‰
          - ä¼šå¯¼è‡´å´©æºƒã€æ•°æ®ä¸¢å¤±ã€å…³é”®åŠŸèƒ½ä¸å¯ç”¨çš„ bug
          - æ˜ç¡®ç ´åç°æœ‰åŠŸèƒ½çš„å›å½’

          ### è½¯é—¨ç¦ï¼ˆéšè½®æ¬¡é€’å‡ï¼‰
          ä»¥ä¸‹é—®é¢˜åœ¨ç¬¬ 1 è½®å¯ä»¥æå‡ºï¼Œç¬¬ 2 è½®åé™ä¸ºå»ºè®®ï¼Œç¬¬ 3 è½®åä¸å†æåŠï¼š
          - ä»£ç åº”è¯¥æ”¾åœ¨å“ªä¸ªæ–‡ä»¶/æ¨¡å—ç»„ç»‡æ–¹å¼
          - ç¼ºå°‘å•å…ƒæµ‹è¯•ï¼ˆé™¤é Issue æ˜ç¡®è¦æ±‚ï¼‰
          - é…ç½®é¡¹çš„é˜²å¾¡æ€§æ ¡éªŒ
          - ä»£ç é£æ ¼ã€å‘½ååå¥½
          - "æ›´å¥½çš„å®ç°æ–¹å¼"

          ### è½®æ¬¡è§„åˆ™
          - ç¬¬ 1 è½®ï¼šå…¨é‡å®¡æ ¸ï¼ˆç¡¬é—¨ç¦ + è½¯é—¨ç¦ï¼‰
          - ç¬¬ 2 è½®èµ·ï¼šåªè¿½è¸ªæœªè§£å†³çš„ç¡¬é—¨ç¦ + æœ¬è½®æ–°å¼•å…¥çš„é«˜é£é™©é—®é¢˜ï¼Œè½¯é—¨ç¦é™ä¸ºå»ºè®®
          - ç¬¬ 3 è½®èµ·ï¼šåªçœ‹ç¡¬é—¨ç¦ï¼Œä¸å†æ–°å¢è½¯é—¨ç¦å»ºè®®
          - ä¾‹å¤–ï¼šå¦‚æœæœ¬è½® diff å˜åŒ–é‡ > ä¸Šä¸€è½®çš„ 50%ï¼Œæˆ–è§¦åŠé«˜é£é™©ç›®å½•ï¼Œé‡ç½®ä¸ºç¬¬ 1 è½®æ ‡å‡†

          ## é˜»å¡é¡¹è¾“å‡ºæ ¼å¼ï¼ˆæ¯æ¡å¿…é¡»åŒ…å«ï¼‰

          ç»™å‡º âš ï¸ æ—¶ï¼Œæ¯æ¡é˜»å¡é—®é¢˜å¿…é¡»æŒ‰ä»¥ä¸‹æ ¼å¼è¯´æ˜ï¼š
          - **é—®é¢˜**ï¼šå…·ä½“æè¿°
          - **è§¦å‘æ¡ä»¶**ï¼šåœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‘ç”Ÿ
          - **ç”¨æˆ·å¯è§åæœ**ï¼šç”¨æˆ·/ç³»ç»Ÿä¼šé‡åˆ°ä»€ä¹ˆå…·ä½“é—®é¢˜
          - **å½±å“èŒƒå›´**ï¼šå½±å“å¤šå¤§ï¼ˆå•ç”¨æˆ·/å…¨éƒ¨ç”¨æˆ·/æ•°æ®å±‚é¢ï¼‰
          - **ç½®ä¿¡åº¦**ï¼šé«˜/ä¸­/ä½

          ç½®ä¿¡åº¦ä¸ºã€Œä½ã€çš„é—®é¢˜é»˜è®¤é™ä¸ºå»ºè®®ï¼Œé™¤éå±äº OWASP Top 10 æˆ–å·²çŸ¥é«˜å±æ¼æ´æ¨¡å¼ã€‚

          ## ç»“è®ºä¸‰é€‰ä¸€

          - âœ… æ¨èåˆå¹¶ â€” Issue éœ€æ±‚å…¨éƒ¨æ»¡è¶³ï¼Œæ— ç¡¬é—¨ç¦é—®é¢˜
          - âš ï¸ éœ€è¦ä¿®æ”¹ â€” å­˜åœ¨ç¡¬é—¨ç¦é—®é¢˜ï¼ˆå¿…é¡»æŒ‰ä¸Šè¿°æ ¼å¼é€æ¡åˆ—å‡ºï¼‰
          - âŒ ä¸å»ºè®®åˆå¹¶ â€” æ–¹å‘å®Œå…¨é”™è¯¯æˆ–å¼•å…¥ä¸¥é‡å®‰å…¨æ¼æ´

          è¶…å‡º Issue èŒƒå›´çš„æ”¹è¿›å»ºè®®å•ç‹¬åˆ—åœ¨ã€Œå»ºè®®ï¼ˆéé˜»å¡ï¼‰ã€åŒºåŸŸï¼Œä¸å½±å“åˆå¹¶ç»“è®ºã€‚
          PROMPT_END
          fi

          {
            echo ""
            echo "PR æ ‡é¢˜ï¼š$PR_TITLE"
            echo ""
            echo "PR æè¿°ï¼š$PR_BODY"
            echo ""
            if [ -n "$ISSUE_CTX" ]; then
              echo "åŸå§‹ Issue å†…å®¹ï¼š"
              echo "$ISSUE_CTX"
              echo ""
            fi
            echo "ä»£ç å˜æ›´ï¼ˆdiffï¼‰ï¼š"
            echo "$DIFF"
          } >> /tmp/review_prompt.txt

          codex \
            -c 'model_providers.custom_openai.name="Custom OpenAI"' \
            -c "model_providers.custom_openai.base_url=\"${{ secrets.CODEX_API_BASE }}\"" \
            -c 'model_providers.custom_openai.env_key="CUSTOM_OPENAI_KEY"' \
            -c 'model_provider="custom_openai"' \
            exec --full-auto -m gpt-5.2 \
            "$(cat /tmp/review_prompt.txt)

          æŠŠå®¡æ ¸ç»“æœå†™å…¥ /tmp/review_result.mdï¼Œæ ¼å¼æ¸…æ™°ï¼Œç”¨ä¸­æ–‡ã€‚"

          cat /tmp/review_result.md 2>/dev/null || echo "å®¡æ ¸æ‰§è¡Œå®Œæˆä½†æœªç”ŸæˆæŠ¥å‘Š" > /tmp/review_result.md

      - name: Post Review Comment & Decide
        if: always()
        id: comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let review = 'å®¡æ ¸æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥';
            try {
              review = fs.readFileSync('/tmp/review_result.md', 'utf8');
            } catch(e) {}

            const source = '${{ steps.source.outputs.source }}';
            const sourceDesc = '${{ steps.source.outputs.desc }}';
            const issueNum = '${{ steps.source.outputs.issue_num }}';
            const round = parseInt('${{ steps.rounds.outputs.count }}') + 1;
            const maxRounds = 3;
            const prNum = ${{ github.event.pull_request.number }};
            const prTitle = '${{ github.event.pull_request.title }}'.replace(/'/g, '');

            const passed = review.includes('âœ…') && !review.includes('âš ï¸') && !review.includes('âŒ');
            const needsFix = review.includes('éœ€è¦ä¿®æ”¹') || review.includes('ä¸å»ºè®®åˆå¹¶') || review.includes('âš ï¸') || review.includes('âŒ');

            const labels = context.payload.pull_request.labels.map(l => l.name);
            const hasAutoFixLabel = labels.includes('auto-fix');
            const canAutoFix = hasAutoFixLabel && round < maxRounds;

            let header = `## ğŸ” PR ä»£ç å®¡æ ¸ï¼ˆç¬¬ ${round}/${maxRounds} è½®ï¼‰\n\n`;
            header += `**æ¥æºï¼š** ${sourceDesc}\n`;
            if (issueNum) header += `**å…³è” Issueï¼š** #${issueNum}\n`;
            header += `**åˆ†æ”¯ï¼š** \`${{ github.event.pull_request.head.ref }}\`\n`;

            // Decide notification type: passed / silent-autofix / max-reached / no-label
            let notifyType = 'none';

            if (passed) {
              header += `\nâœ… **å®¡æ ¸é€šè¿‡ï¼ç­‰å¾…äººå·¥ç¡®è®¤åˆå¹¶ã€‚**\n`;
              notifyType = 'passed';
            } else if (canAutoFix && needsFix) {
              header += `\nğŸ”„ **å®¡æ ¸æœªé€šè¿‡ï¼Œå°†è‡ªåŠ¨è§¦å‘ Codex ä¿®å¤ï¼ˆç¬¬ ${round+1} è½®ï¼‰â€¦**\n`;
              notifyType = 'none'; // silent during auto-fix
            } else if (hasAutoFixLabel && needsFix && round >= maxRounds) {
              header += `\nâ¹ï¸ **å·²è¾¾æœ€å¤§å®¡æ ¸è½®æ¬¡ï¼ˆ${maxRounds}ï¼‰ï¼Œä¸å†è‡ªåŠ¨ä¿®å¤ã€‚è¯·äººå·¥æ£€æŸ¥ã€‚**\n`;
              notifyType = 'max_reached';
            } else if (needsFix && !hasAutoFixLabel) {
              header += `\nğŸ’¡ **å®¡æ ¸æœªé€šè¿‡ã€‚æ·»åŠ  \`auto-fix\` label å¯è§¦å‘è‡ªåŠ¨ä¿®å¤ï¼ˆæœ€å¤š ${maxRounds} è½®ï¼‰ã€‚**\n`;
              notifyType = 'no_label';
            }

            header += `\n---\n\n`;
            header += `<!-- codex-review-round -->\n`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNum,
              body: header + review,
            });

            const shouldFix = hasAutoFixLabel && needsFix && round < maxRounds;
            core.setOutput('should_fix', shouldFix ? 'true' : 'false');
            core.setOutput('round', String(round));
            core.setOutput('notify_type', notifyType);
            core.setOutput('pr_num', String(prNum));
            core.setOutput('pr_title', prTitle);
            core.setOutput('passed', passed ? 'true' : 'false');
            core.setOutput('total_rounds', String(round));

      # === Telegram Notification ===

      - name: Notify â€” review passed
        if: steps.comment.outputs.notify_type == 'passed'
        run: |
          PR_NUM="${{ steps.comment.outputs.pr_num }}"
          PR_TITLE="${{ steps.comment.outputs.pr_title }}"
          PR_URL="https://github.com/uf-hy/pushfile/pull/${PR_NUM}"
          TOTAL_ROUNDS="${{ steps.comment.outputs.total_rounds }}"

          # 1) Notification bot: text message
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_NOTIFY_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
              \"text\": \"âœ… PR #${PR_NUM} å®¡æ ¸é€šè¿‡ï¼ˆç»è¿‡ ${TOTAL_ROUNDS} è½®å®¡æ ¸ï¼‰\\n${PR_TITLE}\\n\\nç­‰å¾…ç¡®è®¤åˆå¹¶\",
              \"disable_notification\": false
            }"

          # 2) fufu bot: action buttons (åŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡ï¼Œç¡®ä¿ä»»ä½•ä¼šè¯éƒ½èƒ½ç›´æ¥æ“ä½œ)
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
              \"text\": \"ğŸ“¦ pushfile â€” PR #${PR_NUM} å®¡æ ¸é€šè¿‡\\næ ‡é¢˜: ${PR_TITLE}\\nè½®æ¬¡: ${TOTAL_ROUNDS}\\né“¾æ¥: ${PR_URL}\\nä»“åº“: uf-hy/pushfile\\nåˆ†æ”¯: ${{ github.event.pull_request.head.ref }}\\n\\næ“ä½œè¯´æ˜:\\nâ€¢ pf_merge_N â†’ squash åˆå¹¶ PR\\nâ€¢ åˆå¹¶åè‡ªåŠ¨ bump ç‰ˆæœ¬ + æ„å»ºé•œåƒ\\nâ€¢ æ¨ production åˆ†æ”¯è§¦å‘è‡ªåŠ¨éƒ¨ç½²\",
              \"reply_markup\": {
                \"inline_keyboard\": [[
                  {\"text\": \"âœ… åˆå¹¶\", \"callback_data\": \"pf_merge_${PR_NUM}\"},
                  {\"text\": \"ğŸ‘€ æŸ¥çœ‹\", \"url\": \"${PR_URL}\"}
                ]]
              }
            }"

      - name: Notify â€” max rounds reached
        if: steps.comment.outputs.notify_type == 'max_reached'
        run: |
          PR_NUM="${{ steps.comment.outputs.pr_num }}"
          PR_TITLE="${{ steps.comment.outputs.pr_title }}"
          PR_URL="https://github.com/uf-hy/pushfile/pull/${PR_NUM}"
          ROUND="${{ steps.comment.outputs.round }}"

          # 1) Notification bot: text message
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_NOTIFY_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
              \"text\": \"âŒ PR #${PR_NUM} ${ROUND}è½®ä¿®å¤ä»æœªé€šè¿‡\\n${PR_TITLE}\\n\\néœ€è¦äººå·¥ä»‹å…¥\",
              \"disable_notification\": false
            }"

          # 2) fufu bot: action buttons (åŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡ï¼Œç¡®ä¿ä»»ä½•ä¼šè¯éƒ½èƒ½ç›´æ¥æ“ä½œ)
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
              \"text\": \"ğŸ“¦ pushfile â€” PR #${PR_NUM} å®¡æ ¸æœªé€šè¿‡\\næ ‡é¢˜: ${PR_TITLE}\\nè½®æ¬¡: ${ROUND}\\né“¾æ¥: ${PR_URL}\\nä»“åº“: uf-hy/pushfile\\nåˆ†æ”¯: ${{ github.event.pull_request.head.ref }}\\n\\næ“ä½œè¯´æ˜:\\nâ€¢ pf_retry_h_N â†’ è§¦å‘ retry.yml (thinking: high)\\nâ€¢ pf_retry_xh_N â†’ è§¦å‘ retry.yml (thinking: xhigh)\\nâ€¢ pf_close_N â†’ å…³é—­ PR\\nâ€¢ retry æ–¹æ³•: POST dispatch retry.yml, inputs: pr_number + thinking_level\",
              \"reply_markup\": {
                \"inline_keyboard\": [
                  [
                    {\"text\": \"ğŸ”„ å†è¯• (high)\", \"callback_data\": \"pf_retry_h_${PR_NUM}\"},
                    {\"text\": \"ğŸ§  xhigh å†è¯•\", \"callback_data\": \"pf_retry_xh_${PR_NUM}\"}
                  ],
                  [
                    {\"text\": \"âŒ å…³é—­ PR\", \"callback_data\": \"pf_close_${PR_NUM}\"},
                    {\"text\": \"ğŸ‘€ æŸ¥çœ‹\", \"url\": \"${PR_URL}\"}
                  ]
                ]
              }
            }"

      # === Auto-fix: only for AI agent PRs, max 3 rounds ===

      - name: Checkout PR branch for fix
        if: steps.comment.outputs.should_fix == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.PAT_TOKEN }}

      - name: Run Codex auto-fix
        if: steps.comment.outputs.should_fix == 'true'
        env:
          CUSTOM_OPENAI_KEY: ${{ secrets.CODEX_API_KEY }}
        run: |
          REVIEW=$(cat /tmp/review_result.md 2>/dev/null || echo "no review")
          cat > /tmp/fix_prompt.txt <<'FIXEOF'
          ä½ æ˜¯ä»£ç ä¿®å¤ä¸“å®¶ã€‚æ ¹æ®ä»¥ä¸‹ä»£ç å®¡æ ¸æ„è§ä¿®æ”¹ä»£ç ã€‚
          åªä¿®å¤å®¡æ ¸ä¸­æ˜ç¡®æŒ‡å‡ºçš„é—®é¢˜ï¼Œä¸è¦åšé¢å¤–çš„é‡æ„æˆ–æ”¹åŠ¨ã€‚
          ä¿®æ”¹å®Œæˆåç¡®ä¿ä»£ç èƒ½æ­£å¸¸è¿è¡Œã€‚
          FIXEOF
          echo "" >> /tmp/fix_prompt.txt
          echo "å®¡æ ¸æ„è§ï¼š" >> /tmp/fix_prompt.txt
          echo "$REVIEW" >> /tmp/fix_prompt.txt

          codex \
            -c 'model_providers.custom_openai.name="Custom OpenAI"' \
            -c "model_providers.custom_openai.base_url=\"${{ secrets.CODEX_API_BASE }}\"" \
            -c 'model_providers.custom_openai.env_key="CUSTOM_OPENAI_KEY"' \
            -c 'model_provider="custom_openai"' \
            exec --full-auto -m gpt-5.2 \
            "$(cat /tmp/fix_prompt.txt)"

      - name: Push fixes
        if: steps.comment.outputs.should_fix == 'true'
        run: |
          git config user.name "Codex"
          git config user.email "codex@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          ROUND="${{ steps.comment.outputs.round }}"
          git commit -m "fix: auto-fix round $((ROUND+1)) based on review feedback"
          git push origin ${{ github.event.pull_request.head.ref }}
