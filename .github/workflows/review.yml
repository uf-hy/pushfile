# PR è‡ªåŠ¨å®¡æ ¸ â€” å¯¹æ‰€æœ‰ PR è¿›è¡Œä»£ç å®¡æŸ¥
# è‡ªåŠ¨è¯†åˆ«æ¥æºï¼šæ‰‹åŠ¨æ¨é€ / Codex Agent / OpenCode Agent
name: PR Review

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]

permissions:
  pull-requests: write
  contents: read

jobs:
  review:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # è·³è¿‡ bot åˆ›å»ºçš„ promote PRï¼ˆproduction syncï¼‰
    if: "!contains(github.event.pull_request.title, 'promote')"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect PR source
        id: source
        run: |
          BRANCH="${{ github.event.pull_request.head.ref }}"

          if echo "$BRANCH" | grep -qE '^codex/issue-'; then
            echo "source=codex-agent" >> $GITHUB_OUTPUT
            echo "issue_num=$(echo $BRANCH | sed 's/codex\/issue-//')" >> $GITHUB_OUTPUT
            echo "desc=ğŸ¤– Codex Agent è‡ªåŠ¨ä¿®å¤ï¼ˆç”± Issue è§¦å‘ï¼‰" >> $GITHUB_OUTPUT
          elif echo "$BRANCH" | grep -qE '^opencode/issue-'; then
            echo "source=opencode-agent" >> $GITHUB_OUTPUT
            echo "issue_num=$(echo $BRANCH | sed 's/opencode\/issue-//')" >> $GITHUB_OUTPUT
            echo "desc=ğŸ¤– OpenCode Agent è‡ªåŠ¨ä¿®å¤ï¼ˆç”± Issue è§¦å‘ï¼‰" >> $GITHUB_OUTPUT
          else
            echo "source=manual" >> $GITHUB_OUTPUT
            echo "issue_num=" >> $GITHUB_OUTPUT
            echo "desc=ğŸ‘¤ äººå·¥æäº¤çš„ PR" >> $GITHUB_OUTPUT
          fi

      - name: Get PR diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr diff ${{ github.event.pull_request.number }} > /tmp/pr_diff.txt 2>/dev/null || echo "Failed to get diff" > /tmp/pr_diff.txt
          head -c 30000 /tmp/pr_diff.txt > /tmp/pr_diff_truncated.txt

      - name: Write PR metadata to files
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const pr = context.payload.pull_request;
            fs.writeFileSync('/tmp/pr_title.txt', pr.title || '');
            fs.writeFileSync('/tmp/pr_body.txt', (pr.body || '').slice(0, 2000));

      - name: Get linked issue context
        if: steps.source.outputs.issue_num != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ steps.source.outputs.issue_num }}"
          gh issue view "$ISSUE_NUM" --json title,body --jq '"Issue #" + (.title) + "\n" + .body' > /tmp/issue_context.txt 2>/dev/null || echo "" > /tmp/issue_context.txt

      - name: Install Codex CLI
        run: npm install -g @openai/codex

      - name: Run AI Review
        env:
          CUSTOM_OPENAI_KEY: ${{ secrets.CODEX_API_KEY }}
        run: |
          SOURCE="${{ steps.source.outputs.source }}"
          PR_TITLE=$(cat /tmp/pr_title.txt)
          PR_BODY=$(cat /tmp/pr_body.txt)
          DIFF=$(cat /tmp/pr_diff_truncated.txt)
          ISSUE_CTX=""
          if [ -f /tmp/issue_context.txt ]; then
            ISSUE_CTX=$(cat /tmp/issue_context.txt)
          fi

          # Build prompt in a file to avoid shell injection
          if [ "$SOURCE" = "manual" ]; then
            cat > /tmp/review_prompt.txt <<'PROMPT_END'
          ä½ æ˜¯ä»£ç å®¡æ ¸ä¸“å®¶ã€‚è¿™æ˜¯ä¸€ä¸ª **äººå·¥æäº¤** çš„ PRï¼Œè¯·ä»¥åä½œè€…çš„è§’åº¦å®¡æ ¸ã€‚

          å®¡æ ¸è¦ç‚¹ï¼š
          1. **ä»£ç è´¨é‡** â€” å¯è¯»æ€§ã€è§„èŒƒæ€§ã€æ˜¯å¦éµå¾ªé¡¹ç›®é£æ ¼
          2. **åŠŸèƒ½æ­£ç¡®æ€§** â€” é€»è¾‘æ˜¯å¦æ­£ç¡®ï¼Œè¾¹ç•Œæƒ…å†µæ˜¯å¦å¤„ç†
          3. **å®‰å…¨æ€§** â€” æœ‰æ— è·¯å¾„éå†ã€æ³¨å…¥ç­‰é£é™©
          4. **å»ºè®®** â€” æœ‰ä»€ä¹ˆå¯ä»¥æ”¹è¿›çš„åœ°æ–¹

          è¯­æ°”ï¼šç®€æ´ä¸“ä¸šï¼Œåƒä¸€ä¸ªé è°±çš„åŒäº‹åœ¨ reviewã€‚ä¸éœ€è¦è¿‡åº¦å¤¸å¥–ã€‚
          PROMPT_END
          else
            cat > /tmp/review_prompt.txt <<PROMPT_END
          ä½ æ˜¯ä»£ç å®¡æ ¸ä¸“å®¶ã€‚è¿™æ˜¯ä¸€ä¸ª **AI Agent (${SOURCE}) è‡ªåŠ¨ç”Ÿæˆ** çš„ PRï¼Œç”± Issue è§¦å‘ã€‚

          å¯¹ AI ç”Ÿæˆçš„ä»£ç è¦æ›´ä¸¥æ ¼å®¡æ ¸ï¼Œé‡ç‚¹å…³æ³¨ï¼š
          1. **éœ€æ±‚åŒ¹é…** â€” æ˜¯å¦çœŸæ­£è§£å†³äº† Issue æè¿°çš„é—®é¢˜ï¼ˆè€Œéè¡¨é¢ä¿®å¤ï¼‰
          2. **ä»£ç è´¨é‡** â€” AI å®¹æ˜“ç”Ÿæˆå†—ä½™ä»£ç ã€è¿‡åº¦æŠ½è±¡ã€æˆ–é—æ¼è¾¹ç•Œæƒ…å†µ
          3. **å®‰å…¨æ€§** â€” AI å¯èƒ½å¼•å…¥ä¸å®‰å…¨çš„æ¨¡å¼ï¼ˆå¦‚æœªéªŒè¯è¾“å…¥ã€ç¡¬ç¼–ç ç­‰ï¼‰
          4. **å‰¯ä½œç”¨** â€” æ˜¯å¦å½±å“äº†å…¶ä»–åŠŸèƒ½
          5. **æ˜¯å¦å€¼å¾—åˆå¹¶** â€” æ˜ç¡®ç»™å‡º âœ… æ¨èåˆå¹¶ / âš ï¸ éœ€è¦ä¿®æ”¹ / âŒ ä¸å»ºè®®åˆå¹¶
          PROMPT_END
          fi

          # Append metadata from files (safe, no shell expansion)
          {
            echo ""
            echo "PR æ ‡é¢˜ï¼š$PR_TITLE"
            echo ""
            echo "PR æè¿°ï¼š$PR_BODY"
            echo ""
            if [ -n "$ISSUE_CTX" ]; then
              echo "åŸå§‹ Issue å†…å®¹ï¼š"
              echo "$ISSUE_CTX"
              echo ""
            fi
            echo "ä»£ç å˜æ›´ï¼ˆdiffï¼‰ï¼š"
            echo "$DIFF"
          } >> /tmp/review_prompt.txt

          FULL_PROMPT=$(cat /tmp/review_prompt.txt)

          codex \
            -c 'model_providers.custom_openai.name="Custom OpenAI"' \
            -c "model_providers.custom_openai.base_url=\"${{ secrets.CODEX_API_BASE }}\"" \
            -c 'model_providers.custom_openai.env_key="CUSTOM_OPENAI_KEY"' \
            -c 'model_provider="custom_openai"' \
            exec --full-auto -m gpt-5.2 \
            "$(cat /tmp/review_prompt.txt)

          æŠŠå®¡æ ¸ç»“æœå†™å…¥ /tmp/review_result.mdï¼Œæ ¼å¼æ¸…æ™°ï¼Œç”¨ä¸­æ–‡ã€‚"

          cat /tmp/review_result.md 2>/dev/null || echo "å®¡æ ¸æ‰§è¡Œå®Œæˆä½†æœªç”ŸæˆæŠ¥å‘Š" > /tmp/review_result.md

      - name: Post Review Comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let review = 'å®¡æ ¸æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥';
            try {
              review = fs.readFileSync('/tmp/review_result.md', 'utf8');
            } catch(e) {}

            const source = '${{ steps.source.outputs.source }}';
            const sourceDesc = '${{ steps.source.outputs.desc }}';
            const issueNum = '${{ steps.source.outputs.issue_num }}';

            let header = `## ğŸ” PR ä»£ç å®¡æ ¸\n\n`;
            header += `**æ¥æºï¼š** ${sourceDesc}\n`;
            if (issueNum) {
              header += `**å…³è” Issueï¼š** #${issueNum}\n`;
            }
            header += `**åˆ†æ”¯ï¼š** \`${{ github.event.pull_request.head.ref }}\`\n\n---\n\n`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.pull_request.number }},
              body: header + review,
            });
