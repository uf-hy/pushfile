# ç”Ÿäº§éƒ¨ç½² â€” æ‰‹åŠ¨è§¦å‘ æˆ– ç”± build.yml è°ƒç”¨
name: Production Deploy

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'é•œåƒæ ‡ç­¾ï¼ˆé»˜è®¤ latestï¼‰'
        required: false
        default: 'latest'
  workflow_call:
    secrets:
      PROD_SERVER_HOST:
        required: true
      PROD_SERVER_USER:
        required: true
      PROD_SERVER_SSH_KEY:
        required: true
      PROD_SERVER_SSH_PORT:
        required: true
      TELEGRAM_NOTIFY_TOKEN:
        required: true
      TELEGRAM_CHAT_ID:
        required: true

permissions:
  contents: write
  issues: write

env:
  IMAGE: ghcr.io/uf-hy/pushfile
  CONTAINER: pushfile-prod

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Production
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          port: ${{ secrets.PROD_SERVER_SSH_PORT }}
          script: |
            deploy ${{ inputs.image_tag || 'latest' }}

      - name: Notify Telegram â€” success
        if: success()
        run: |
          TEXT="âœ… *pushfile å·²éƒ¨ç½²åˆ°ç”Ÿäº§*

æäº¤: \`${GITHUB_SHA:0:7}\`
é•œåƒ: \`${{ env.IMAGE }}:${{ inputs.image_tag || 'latest' }}\`"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_NOTIFY_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$TEXT" \
            -d parse_mode="Markdown" > /dev/null

      - name: Notify Telegram â€” failure
        if: failure()
        run: |
          TEXT="ğŸš¨ *pushfile ç”Ÿäº§éƒ¨ç½²å¤±è´¥ï¼*

æäº¤: \`${GITHUB_SHA:0:7}\`
æ—¥å¿—: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

è¯·æ£€æŸ¥ï¼"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_NOTIFY_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$TEXT" \
            -d parse_mode="Markdown" > /dev/null

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ ç”Ÿäº§éƒ¨ç½²å¤±è´¥',
              body: `éƒ¨ç½²å¤±è´¥ï¼\n\nCommit: ${context.sha}\nWorkflow: ${context.runId}\n\nè¯·æ£€æŸ¥æ—¥å¿—å¹¶æ‰‹åŠ¨å¤„ç†ã€‚`,
              labels: ['deploy-failed'],
            });
