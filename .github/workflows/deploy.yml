# ç”Ÿäº§éƒ¨ç½² â€” ç”± build.yml å®Œæˆåè§¦å‘ï¼Œç¡®ä¿é•œåƒå·²æ¨é€
name: Production Deploy

on:
  workflow_run:
    workflows: ["Build & Push Docker Image"]
    types: [completed]
    branches: [production]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'é•œåƒæ ‡ç­¾ï¼ˆé»˜è®¤ productionï¼‰'
        required: false
        default: 'production'

permissions:
  contents: write
  issues: write

env:
  IMAGE: ghcr.io/uf-hy/pushfile
  CONTAINER: pushfile-prod

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Deploy to Production
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          port: ${{ secrets.PROD_SERVER_SSH_PORT }}
          script: |
            deploy ${{ github.event.inputs.image_tag || 'production' }}

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ ç”Ÿäº§éƒ¨ç½²å¤±è´¥',
              body: `éƒ¨ç½²å¤±è´¥ï¼\n\nCommit: ${context.sha}\nWorkflow: ${context.runId}\n\nè¯·æ£€æŸ¥æ—¥å¿—å¹¶æ‰‹åŠ¨å¤„ç†ã€‚`,
              labels: ['deploy-failed'],
            });
