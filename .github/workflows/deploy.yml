# ç”Ÿäº§éƒ¨ç½² â€” æ‰‹åŠ¨è§¦å‘
name: Production Deploy

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'é•œåƒæ ‡ç­¾ï¼ˆé»˜è®¤ latestï¼‰'
        required: false
        default: 'latest'

permissions:
  contents: write
  issues: write

env:
  IMAGE: ghcr.io/uf-hy/pushfile

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Production
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          port: ${{ secrets.PROD_SERVER_SSH_PORT }}
          script: |
            deploy ${{ inputs.image_tag || 'latest' }}

      - name: Notify Telegram â€” success
        if: success()
        run: |
          TEXT="âœ… *pushfile å·²éƒ¨ç½²åˆ°ç”Ÿäº§*
          
          æäº¤: \`${GITHUB_SHA:0:7}\`
          é•œåƒ: \`${{ env.IMAGE }}:${{ inputs.image_tag || 'latest' }}\`"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_NOTIFY_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$TEXT" \
            -d parse_mode="Markdown" > /dev/null

      - name: Notify Telegram â€” failure
        if: failure()
        run: |
          TEXT="ðŸš¨ *pushfile ç”Ÿäº§éƒ¨ç½²å¤±è´¥ï¼*
          
          æ—¥å¿—: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_NOTIFY_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$TEXT" \
            -d parse_mode="Markdown" > /dev/null
