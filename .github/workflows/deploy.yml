# ç”Ÿäº§éƒ¨ç½² â€” ç”± build.yml å®Œæˆåè§¦å‘ï¼Œç¡®ä¿é•œåƒå·²æ¨é€
name: Production Deploy

on:
  workflow_run:
    workflows: ["Build & Push Docker Image"]
    types: [completed]
    branches: [main, production]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'é•œåƒæ ‡ç­¾ï¼ˆé»˜è®¤ productionï¼‰'
        required: false
        default: 'production'

permissions:
  contents: write
  issues: write

env:
  IMAGE: ghcr.io/uf-hy/pushfile
  CONTAINER: pushfile-prod

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Deploy to Production
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          port: ${{ secrets.PROD_SERVER_SSH_PORT }}
          script: |
            deploy ${{ github.event.inputs.image_tag || 'production' }}

      - name: Notify Telegram â€” success
        if: success()
        run: |
          COMMIT_MSG=$(echo '${{ github.event.workflow_run.head_commit.message || 'manual dispatch' }}' | head -1)
          TEXT="âœ… *pushfile å·²éƒ¨ç½²åˆ°ç”Ÿäº§*

æäº¤: \`${GITHUB_SHA:0:7}\`
è§¦å‘: ${{ github.event_name }}
é•œåƒ: \`${{ env.IMAGE }}:production\`

$COMMIT_MSG"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_NOTIFY_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$TEXT" \
            -d parse_mode="Markdown" > /dev/null

      - name: Notify Telegram â€” failure
        if: failure()
        run: |
          TEXT="ğŸš¨ *pushfile ç”Ÿäº§éƒ¨ç½²å¤±è´¥ï¼*

æäº¤: \`${GITHUB_SHA:0:7}\`
æ—¥å¿—: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

è¯·æ£€æŸ¥ï¼"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_NOTIFY_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$TEXT" \
            -d parse_mode="Markdown" > /dev/null

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ ç”Ÿäº§éƒ¨ç½²å¤±è´¥',
              body: `éƒ¨ç½²å¤±è´¥ï¼\n\nCommit: ${context.sha}\nWorkflow: ${context.runId}\n\nè¯·æ£€æŸ¥æ—¥å¿—å¹¶æ‰‹åŠ¨å¤„ç†ã€‚`,
              labels: ['deploy-failed'],
            });
