# PR é¢„è§ˆéƒ¨ç½² â€” æ¯ä¸ª PR è‡ªåŠ¨èµ·ä¸€ä¸ª Docker é¢„è§ˆçŽ¯å¢ƒ
# é€šè¿‡ SSH è¿žæŽ¥åˆ°ä½ çš„æœåŠ¡å™¨éƒ¨ç½²
name: Preview Deploy

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

permissions:
  pull-requests: write

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    steps:
      - uses: actions/checkout@v4

      - name: Deploy Preview
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: root
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            PR_NUM=${{ github.event.pull_request.number }}
            PREVIEW_PORT=$((35000 + PR_NUM))
            CONTAINER_NAME="pushfile-preview-${PR_NUM}"
            PREVIEW_DIR="/tmp/pushfile-preview-${PR_NUM}"
            
            # æ¸…ç†æ—§çš„
            docker rm -f "$CONTAINER_NAME" 2>/dev/null || true
            rm -rf "$PREVIEW_DIR"
            
            # æ‹‰å– PR ä»£ç 
            git clone --depth 1 -b "${{ github.head_ref }}" \
              "https://github.com/uf-hy/pushfile.git" "$PREVIEW_DIR"
            
            # æž„å»ºå¹¶å¯åŠ¨
            cd "$PREVIEW_DIR"
            docker build -t "pushfile-preview:pr-${PR_NUM}" .
            docker run -d \
              --name "$CONTAINER_NAME" \
              -p "${PREVIEW_PORT}:8000" \
              -e UPLOAD_SECRET=preview-test-key \
              -e UPLOAD_BASE=/tmp/preview-uploads \
              -e SITE_DOMAIN=preview-${PR_NUM}.photo.xaihub.de \
              "pushfile-preview:pr-${PR_NUM}"
            
            echo "Preview deployed on port ${PREVIEW_PORT}"

      - name: Comment Preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const prNum = context.payload.pull_request.number;
            const port = 35000 + prNum;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNum,
              body: `ðŸš€ **é¢„è§ˆçŽ¯å¢ƒå·²éƒ¨ç½²**\n\n` +
                `- ç®¡ç†åŽå°: http://${{ secrets.SERVER_HOST }}:${port}/\n` +
                `- é¢„è§ˆå¯†ç : \`preview-test-key\`\n\n` +
                `æ¯æ¬¡æŽ¨é€ä»£ç ä¼šè‡ªåŠ¨æ›´æ–°é¢„è§ˆã€‚PR å…³é—­åŽè‡ªåŠ¨é”€æ¯ã€‚`
            });

  cleanup-preview:
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    steps:
      - name: Cleanup Preview
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: root
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            PR_NUM=${{ github.event.pull_request.number }}
            docker rm -f "pushfile-preview-${PR_NUM}" 2>/dev/null || true
            docker rmi "pushfile-preview:pr-${PR_NUM}" 2>/dev/null || true
            rm -rf "/tmp/pushfile-preview-${PR_NUM}"
            echo "Preview for PR #${PR_NUM} cleaned up"
